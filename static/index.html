<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SenTrack — Sentiment Oracle</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.1/dist/chartjs-chart-financial.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.4/dist/ethers.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --bg-primary: #0a0e17;
        --bg-card: rgba(15, 23, 42, 0.7);
        --border: rgba(100, 120, 180, 0.15);
        --text-primary: #e2e8f0;
        --text-secondary: #94a3b8;
        --text-muted: #64748b;
        --accent-bullish: #22c55e;
        --accent-bearish: #ef4444;
        --accent-neutral: #f59e0b;
        --accent-blue: #3b82f6;
      }

      body {
        font-family: "Inter", -apple-system, sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      /* Header */
      .header {
        text-align: center;
        padding: 30px 0;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        margin-bottom: 20px;
        backdrop-filter: blur(20px);
      }

      .header h1 {
        font-size: 2.5rem;
        font-weight: 800;
        background: linear-gradient(135deg, #e2e8f0, #3b82f6, #8b5cf6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        letter-spacing: -0.02em;
      }

      /* Mode Toggle */
      .mode-toggle-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .mode-toggle {
        display: inline-flex;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 6px;
        gap: 6px;
        backdrop-filter: blur(20px);
      }

      .controls-group {
        display: flex;
        align-items: center;
        gap: 12px;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 8px 16px;
        backdrop-filter: blur(20px);
      }

      .dataset-select {
        padding: 8px 16px;
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text-primary);
        font-family: "Inter", sans-serif;
        font-size: 0.85rem;
        cursor: pointer;
        transition: border-color 0.3s;
        outline: none;
      }

      .dataset-select:hover {
        border-color: rgba(100, 120, 180, 0.35);
      }

      .btn {
        padding: 8px 20px;
        border: none;
        border-radius: 8px;
        font-family: "Inter", sans-serif;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        background: var(--accent-blue);
        color: white;
      }

      .btn:hover {
        background: #2563eb;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-secondary {
        background: rgba(100, 120, 180, 0.2);
        color: var(--text-primary);
      }

      .btn-secondary:hover {
        background: rgba(100, 120, 180, 0.3);
      }

      .btn-contribute {
        background: linear-gradient(135deg, #7c3aed, #6d28d9);
        color: white;
      }
      .btn-contribute:hover {
        background: linear-gradient(135deg, #6d28d9, #5b21b6);
        box-shadow: 0 4px 16px rgba(124, 58, 237, 0.35);
        transform: translateY(-1px);
      }

      /* ── Modal ── */
      .modal-overlay {
        position: fixed; inset: 0; z-index: 1000;
        background: rgba(0,0,0,0.65); backdrop-filter: blur(6px);
        display: flex; align-items: center; justify-content: center;
      }
      .modal-card {
        background: var(--card-bg); border: 1px solid var(--border);
        border-radius: 16px; width: 420px; max-width: 92vw;
        box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        overflow: hidden;
      }
      .modal-header {
        display: flex; justify-content: space-between; align-items: center;
        padding: 18px 24px; border-bottom: 1px solid var(--border);
      }
      .modal-header h3 { font-size: 1.05rem; font-weight: 700; color: var(--text-primary); }
      .modal-close {
        background: none; border: none; color: var(--text-secondary);
        font-size: 1.5rem; cursor: pointer; line-height: 1;
      }
      .modal-close:hover { color: var(--text-primary); }
      .modal-body { padding: 28px 24px; text-align: center; }

      .contrib-step { animation: fadeIn 0.3s ease; }
      .contrib-icon { font-size: 2.2rem; margin-bottom: 12px; }
      .contrib-phase { color: var(--text-primary); font-weight: 600; font-size: 0.95rem; margin-bottom: 14px; }
      .contrib-progress-bar {
        height: 6px; background: rgba(100,120,180,0.15); border-radius: 3px;
        overflow: hidden; margin-bottom: 10px;
      }
      .contrib-progress-fill {
        height: 100%; width: 0%; border-radius: 3px;
        background: linear-gradient(90deg, #7c3aed, #a78bfa);
        transition: width 0.5s ease;
      }
      .contrib-stats { color: var(--text-secondary); font-size: 0.82rem; }
      .contrib-score-display { margin: 16px 0 8px; }
      .contrib-score-value {
        font-size: 2.8rem; font-weight: 900; letter-spacing: -2px;
        background: linear-gradient(135deg, #7c3aed, #a78bfa);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      }
      .contrib-score-label {
        display: block; font-size: 0.9rem; font-weight: 600;
        margin-top: 2px;
      }
      .contrib-score-label.bullish { color: var(--accent-bullish); }
      .contrib-score-label.bearish { color: var(--accent-bearish); }
      .contrib-score-label.neutral { color: var(--accent-blue); }
      .contrib-meta { color: var(--text-secondary); font-size: 0.82rem; margin-top: 4px; }
      .contrib-tx-hash {
        margin-top: 12px; padding: 10px; background: rgba(100,120,180,0.08);
        border-radius: 8px; font-family: monospace; font-size: 0.75rem;
        color: var(--accent-blue); word-break: break-all;
      }

      @keyframes fadeIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }

      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 26px;
      }

      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(100, 120, 180, 0.2);
        transition: 0.4s;
        border-radius: 26px;
      }

      .toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }

      input:checked + .toggle-slider {
        background-color: var(--accent-blue);
      }

      input:checked + .toggle-slider:before {
        transform: translateX(24px);
      }

      .toggle-label {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-right: 8px;
      }

      .mode-btn {
        padding: 12px 32px;
        border: none;
        border-radius: 8px;
        font-family: "Inter", sans-serif;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        background: transparent;
        color: var(--text-muted);
      }

      .mode-btn.active {
        background: var(--accent-blue);
        color: white;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      }

      .mode-btn:hover:not(.active) {
        color: var(--text-primary);
        background: rgba(100, 120, 180, 0.1);
      }

      /* Main Layout */
      .main-layout {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 20px;
      }

      /* Left Section */
      .left-section {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      /* Top Info Row */
      .info-row {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
      }

      .info-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 24px;
        backdrop-filter: blur(20px);
        transition: all 0.3s;
      }

      .info-card:hover {
        border-color: rgba(100, 120, 180, 0.3);
        transform: translateY(-2px);
      }

      .info-card h3 {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-bottom: 12px;
      }

      .info-card .value {
        font-size: 2.5rem;
        font-weight: 900;
        line-height: 1;
        margin-bottom: 8px;
      }

      .info-card .value.bullish { color: var(--accent-bullish); }
      .info-card .value.bearish { color: var(--accent-bearish); }
      .info-card .value.neutral { color: var(--accent-neutral); }

      .info-card .label {
        font-size: 0.85rem;
        color: var(--text-secondary);
      }

      .badge {
        display: inline-block;
        padding: 6px 16px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .badge.bullish {
        background: linear-gradient(135deg, #22c55e, #10b981);
        color: white;
      }
      .badge.bearish {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
      }
      .badge.neutral {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
      }

      .details-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .detail-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid var(--border);
      }

      .detail-item:last-child {
        border-bottom: none;
      }

      .detail-label {
        font-size: 0.85rem;
        color: var(--text-secondary);
      }

      .detail-value {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-primary);
      }

      /* Chart Card */
      .chart-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 24px;
        backdrop-filter: blur(20px);
        min-height: 400px;
      }

      .chart-card h3 {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-bottom: 20px;
      }

      .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .chart-selector {
        display: flex;
        gap: 8px;
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 4px;
      }

      .chart-btn {
        padding: 6px 16px;
        border: none;
        border-radius: 6px;
        font-family: "Inter", sans-serif;
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        background: transparent;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .chart-btn:hover {
        color: var(--text-primary);
      }

      .chart-btn.active {
        background: var(--accent-blue);
        color: white;
      }

      .chart-container {
        position: relative;
        height: 350px;
      }

      .chart-wrapper {
        display: none;
        height: 100%;
      }

      .chart-wrapper.active {
        display: block;
      }

      /* Right Section - News */
      .right-section {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .news-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
        backdrop-filter: blur(20px);
      }

      .news-card h3 {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border);
      }

      .news-item {
        padding: 16px;
        background: rgba(100, 120, 180, 0.05);
        border-radius: 8px;
        margin-bottom: 12px;
        border-left: 3px solid transparent;
        transition: all 0.3s;
      }

      .news-item:hover {
        background: rgba(100, 120, 180, 0.1);
        transform: translateX(4px);
      }

      .news-item.bullish {
        border-left-color: var(--accent-bullish);
      }

      .news-item.bearish {
        border-left-color: var(--accent-bearish);
      }

      .news-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
        line-height: 1.4;
      }

      .news-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.75rem;
        color: var(--text-secondary);
      }

      .news-score {
        font-weight: 700;
        padding: 2px 8px;
        border-radius: 4px;
        background: rgba(59, 130, 246, 0.1);
      }

      .news-score.bullish { 
        color: var(--accent-bullish);
        background: rgba(34, 197, 94, 0.1);
      }
      .news-score.bearish { 
        color: var(--accent-bearish);
        background: rgba(239, 68, 68, 0.1);
      }

      .latest-news-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
        backdrop-filter: blur(20px);
        max-height: 400px;
        overflow-y: auto;
      }

      .latest-news-card h3 {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border);
        position: sticky;
        top: 0;
        background: var(--bg-card);
        backdrop-filter: blur(20px);
        z-index: 1;
      }

      .news-article {
        padding: 12px;
        border-bottom: 1px solid var(--border);
        transition: background 0.3s;
      }

      .news-article:hover {
        background: rgba(100, 120, 180, 0.05);
      }

      .news-article:last-child {
        border-bottom: none;
      }

      .article-title {
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--text-primary);
        line-height: 1.4;
        margin-bottom: 6px;
      }

      .article-time {
        font-size: 0.7rem;
        color: var(--text-secondary);
      }

      /* Loading spinner */
      .spinner {
        border: 3px solid var(--border);
        border-top: 3px solid var(--accent-blue);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* Scrollbar styling */
      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: rgba(100, 120, 180, 0.05);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb {
        background: rgba(100, 120, 180, 0.2);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: rgba(100, 120, 180, 0.3);
      }

      /* Responsive */
      @media (max-width: 1200px) {
        .main-layout {
          grid-template-columns: 1fr;
        }
        
        .info-row {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 768px) {
        .header h1 {
          font-size: 1.8rem;
        }
        
        .mode-btn {
          padding: 10px 20px;
          font-size: 0.85rem;
        }
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
      }

      /* ── On-Chain Mode ── */
      .btn-wallet {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .btn-wallet:hover {
        background: linear-gradient(135deg, #d97706, #b45309);
        box-shadow: 0 4px 16px rgba(245, 158, 11, 0.35);
        transform: translateY(-1px);
      }
      .btn-wallet.connected {
        background: linear-gradient(135deg, #22c55e, #16a34a);
      }
      .btn-wallet.connected:hover {
        background: linear-gradient(135deg, #16a34a, #15803d);
        box-shadow: 0 4px 16px rgba(34, 197, 94, 0.35);
      }
      .onchain-addr-input {
        padding: 8px 14px;
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text-primary);
        font-family: monospace;
        font-size: 0.8rem;
        width: 260px;
        outline: none;
        transition: border-color 0.3s;
      }
      .onchain-addr-input:focus {
        border-color: rgba(245, 158, 11, 0.5);
      }
      .onchain-addr-input::placeholder {
        color: var(--text-muted);
        font-family: 'Inter', sans-serif;
        font-size: 0.8rem;
      }
      .wallet-badge {
        font-family: monospace;
        font-size: 0.8rem;
        color: var(--accent-bullish);
        padding: 6px 12px;
        background: rgba(34, 197, 94, 0.1);
        border: 1px solid rgba(34, 197, 94, 0.2);
        border-radius: 8px;
      }
      .onchain-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        padding: 40px 20px;
        color: var(--text-secondary);
        font-size: 0.9rem;
      }
      .onchain-loading .spinner {
        border-top-color: #f59e0b;
      }
      .mode-btn.onchain-active {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <div class="header">
        <h1>SenTrack</h1>
      </div>

      <!-- Mode Toggle -->
      <div class="mode-toggle-container">
        <div class="mode-toggle">
          <button class="mode-btn active" id="testModeBtn">Test / Demo</button>
          <button class="mode-btn" id="liveModeBtn">Live</button>
          <button class="mode-btn" id="onchainModeBtn">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -2px; margin-right: 4px;"><path d="M13.73 21a2 2 0 0 1-3.46 0"/><path d="M18.63 13A17.89 17.89 0 0 1 18 8"/><path d="M6.26 6.26A5.86 5.86 0 0 0 6 8c0 7-3 9-3 9h14"/><path d="M18 8a6 6 0 0 0-9.33-5"/></svg>On-Chain
          </button>
        </div>

        <!-- Controls Group -->
        <div class="controls-group" id="controlsGroup">
          <!-- Dataset Selector (Test Mode Only) -->
          <select class="dataset-select" id="datasetSelect" style="display: none;">
            <option value="sample">Sample Tweets</option>
            <option value="kaggle_sentiment140">Sentiment140 (Kaggle)</option>
            <option value="kaggle_bitcoin">Bitcoin Sentiment (Kaggle)</option>
          </select>

          <!-- Auto Analysis Toggle -->
          <span class="toggle-label">Auto</span>
          <label class="toggle-switch">
            <input type="checkbox" id="autoToggle">
            <span class="toggle-slider"></span>
          </label>
          
          <!-- Interval Selector (shown when auto is enabled) -->
          <select class="dataset-select" id="intervalSelect" style="display: none;">
            <option value="30s">30 sec</option>
            <option value="1min" selected>1 min</option>
            <option value="2min">2 min</option>
            <option value="5min">5 min</option>
            <option value="10min">10 min</option>
            <option value="30min">30 min</option>
            <option value="1hr">1 hour</option>
          </select>
          
          <!-- Status Indicator -->
          <div id="statusIndicator" style="display: none; padding: 8px 16px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; font-size: 0.85rem; color: var(--accent-blue);">
            <span id="statusText">● Collecting...</span>
          </div>
          
          <!-- Article Counter -->
          <div id="articleCounter" style="display: none; padding: 8px 16px; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px; font-size: 0.85rem; color: var(--accent-bullish); font-weight: 600;">
            <span id="counterText">0 articles</span>
          </div>

          <!-- Analyze Button -->
          <button class="btn" id="analyzeBtn">Analyze Now</button>

          <!-- Contribute Button -->
          <button class="btn btn-contribute" id="contributeBtn" title="Run a 1-min scan & push score on-chain">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -2px; margin-right: 5px;"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>Contribute
          </button>
        </div>

        <!-- On-Chain Controls (hidden by default) -->
        <div class="controls-group" id="onchainControlsGroup" style="display: none;">
          <button class="btn btn-wallet" id="walletConnectBtn">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
            Connect Wallet
          </button>
          <span class="wallet-badge" id="walletBadge" style="display: none;"></span>
          <input type="text" class="onchain-addr-input" id="onchainContractInput" placeholder="Contract address (0x...)" />
          <button class="btn" id="onchainRefreshBtn">Refresh</button>
          <div id="onchainStatusText" style="font-size: 0.82rem; color: var(--text-secondary);"></div>
        </div>
      </div>

      <!-- Contribute Modal Overlay -->
      <div id="contributeModal" class="modal-overlay" style="display:none;">
        <div class="modal-card">
          <div class="modal-header">
            <h3>Contribute to Chain</h3>
            <button class="modal-close" id="contributeModalClose">&times;</button>
          </div>
          <div class="modal-body">
            <!-- Step 1: Scanning -->
            <div id="contribStep1" class="contrib-step">
              <div class="contrib-icon">&#128225;</div>
              <div class="contrib-phase" id="contribPhaseText">Scanning multiple crypto sources...</div>
              <div class="contrib-progress-bar"><div class="contrib-progress-fill" id="contribProgressFill"></div></div>
              <div class="contrib-stats" id="contribStats">0 unique articles collected</div>
              <button class="btn btn-secondary" id="contribCancelBtn" style="margin-top:12px;">Cancel</button>
            </div>
            <!-- Step 2: Result — choose Submit or Dismiss -->
            <div id="contribStep2" class="contrib-step" style="display:none;">
              <div class="contrib-icon" id="contribResultIcon">&#9989;</div>
              <div style="font-size: 0.78rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 4px;">Scan Complete</div>
              <div class="contrib-score-display">
                <span class="contrib-score-value" id="contribScoreValue">--</span>
                <span class="contrib-score-label" id="contribScoreLabel">Neutral</span>
              </div>
              <div class="contrib-meta" id="contribMeta">25 sampled / 97 collected &middot; FinBERT</div>
              <div style="margin-top: 18px; display: flex; gap: 10px;">
                <button class="btn btn-contribute" id="contribPushBtn" style="flex: 1;">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:5px;"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                  Submit On-Chain
                </button>
                <button class="btn btn-secondary" id="contribDismissBtn" style="flex: 0.6;">
                  Dismiss
                </button>
              </div>
              <div style="font-size: 0.72rem; color: var(--text-muted); margin-top: 10px;">
                Submit pushes this score to the smart contract via MetaMask.<br>
                Dismiss closes without writing anything on-chain.
              </div>
            </div>
            <!-- Step 3: Transaction -->
            <div id="contribStep3" class="contrib-step" style="display:none;">
              <div class="contrib-icon" id="contribTxIcon">&#9981;</div>
              <div class="contrib-phase" id="contribTxText">Waiting for wallet...</div>
              <div class="contrib-tx-hash" id="contribTxHash" style="display:none;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Layout -->
      <div class="main-layout">
        <!-- Left Section -->
        <div class="left-section">
          <!-- Info Row -->
          <div class="info-row">
            <!-- Score Card -->
            <div class="info-card">
              <h3>Score</h3>
              <div class="value neutral" id="scoreValue">--</div>
              <div class="label">Community Vibe</div>
            </div>

            <!-- Market Sentiment Card -->
            <div class="info-card">
              <h3>Market Sentiment</h3>
              <span class="badge neutral" id="sentimentBadge">Neutral</span>
            </div>

            <!-- Analysis Details Card -->
            <div class="info-card">
              <h3>Analysis Details</h3>
              <div class="details-list">
                <div class="detail-item">
                  <span class="detail-label">Sample Size</span>
                  <span class="detail-value" id="sampleSize">--</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Raw Score</span>
                  <span class="detail-value" id="rawScore">--</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Engine</span>
                  <span class="detail-value" id="engine">--</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Chart Card -->
          <div class="chart-card">
            <div class="chart-header">
              <h3>Sentiment Analysis</h3>
              <div class="chart-selector">
                <button class="chart-btn active" data-chart="line">Line</button>
                <button class="chart-btn" data-chart="bar">Bar</button>
                <button class="chart-btn" data-chart="candlestick">Candlestick</button>
              </div>
            </div>
            <div class="chart-container">
              <div class="chart-wrapper active" id="lineChartWrapper">
                <canvas id="trendChart"></canvas>
              </div>
              <div class="chart-wrapper" id="barChartWrapper">
                <canvas id="barChart"></canvas>
              </div>
              <div class="chart-wrapper" id="candlestickChartWrapper">
                <canvas id="candlestickChart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Section - News -->
        <div class="right-section">
          <!-- Most Bullish News -->
          <div class="news-card">
            <h3>Most Bullish</h3>
            <div class="news-item bullish" id="mostBullish">
              <div class="news-title">Loading...</div>
              <div class="news-meta">
                <span>--</span>
                <span class="news-score bullish">--</span>
              </div>
            </div>
          </div>

          <!-- Most Bearish News -->
          <div class="news-card">
            <h3>Most Bearish</h3>
            <div class="news-item bearish" id="mostBearish">
              <div class="news-title">Loading...</div>
              <div class="news-meta">
                <span>--</span>
                <span class="news-score bearish">--</span>
              </div>
            </div>
          </div>

          <!-- Latest News -->
          <div class="latest-news-card">
            <h3>Latest News</h3>
            <div id="latestNews">
              <div class="spinner"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentMode = 'test';
      let currentDataset = 'sample';
      let currentChartType = 'line';
      let chart = null;
      let barChart = null;
      let candlestickChart = null;
      let autoRefreshInterval = null;

      // Initialize
      async function init() {
        await fetchScore();
        await fetchHistory();
        setupEventListeners();
        await syncAutomationState();
      }

      async function syncAutomationState() {
        // On page load, check if backend has a running automation and stop it
        // The toggle starts unchecked, so backend should not be running
        try {
          const resp = await fetch('/api/live/status');
          const status = await resp.json();
          if (status.active) {
            console.log('Backend automation was running on page load — stopping it');
            await fetch('/api/live/automation', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ action: 'stop' })
            });
          }
        } catch (e) {
          console.warn('Could not sync automation state:', e);
        }
      }

      function setupEventListeners() {
        // Mode buttons
        document.getElementById('testModeBtn').addEventListener('click', () => switchMode('test'));
        document.getElementById('liveModeBtn').addEventListener('click', () => switchMode('live'));
        document.getElementById('onchainModeBtn').addEventListener('click', () => switchMode('onchain'));

        // On-chain controls
        document.getElementById('walletConnectBtn').addEventListener('click', connectOnChainWallet);
        document.getElementById('onchainRefreshBtn').addEventListener('click', fetchOnChainData);
        document.getElementById('onchainContractInput').addEventListener('keydown', (e) => {
          if (e.key === 'Enter') fetchOnChainData();
        });
        
        // Dataset selector
        document.getElementById('datasetSelect').addEventListener('change', (e) => {
          currentDataset = e.target.value;
        });
        
        // Auto toggle
        document.getElementById('autoToggle').addEventListener('change', (e) => {
          const intervalSelect = document.getElementById('intervalSelect');
          const statusIndicator = document.getElementById('statusIndicator');
          const articleCounter = document.getElementById('articleCounter');
          
          if (e.target.checked) {
            intervalSelect.style.display = 'block';
            statusIndicator.style.display = 'block';
            
            if (currentMode === 'live') {
              articleCounter.style.display = 'block';
              document.getElementById('statusText').textContent = '● Live: Collecting news...';
              document.getElementById('counterText').textContent = '0 articles';
              startLiveAutomation();
            } else {
              articleCounter.style.display = 'none';
              document.getElementById('statusText').textContent = '● Auto: Analyzing...';
              startAutoRefresh();
            }
          } else {
            intervalSelect.style.display = 'none';
            statusIndicator.style.display = 'none';
            articleCounter.style.display = 'none';
            
            if (currentMode === 'live') {
              stopLiveAutomation();
            } else {
              stopAutoRefresh();
            }
          }
        });
        
        // Interval selector change
        document.getElementById('intervalSelect').addEventListener('change', () => {
          if (document.getElementById('autoToggle').checked) {
            if (currentMode === 'live') {
              stopLiveAutomation();
              startLiveAutomation();
            } else {
              stopAutoRefresh();
              startAutoRefresh();
            }
          }
        });
        
        // Analyze button
        document.getElementById('analyzeBtn').addEventListener('click', triggerAnalysis);
        
        // Chart type buttons
        document.querySelectorAll('.chart-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const chartType = e.target.dataset.chart;
            switchChartType(chartType);
          });
        });
      }

      async function switchMode(mode) {
        // Stop any active automation first
        const autoToggle = document.getElementById('autoToggle');
        if (autoToggle.checked) {
          if (currentMode === 'live') {
            await stopLiveAutomation();
          } else {
            stopAutoRefresh();
          }
          autoToggle.checked = false;
          document.getElementById('intervalSelect').style.display = 'none';
          document.getElementById('statusIndicator').style.display = 'none';
          document.getElementById('articleCounter').style.display = 'none';
        }
        
        currentMode = mode;
        
        // Update UI — remove all active states
        document.querySelectorAll('.mode-btn').forEach(btn => {
          btn.classList.remove('active');
          btn.classList.remove('onchain-active');
        });
        const activeBtn = document.getElementById(`${mode}ModeBtn`);
        if (mode === 'onchain') {
          activeBtn.classList.add('onchain-active');
        } else {
          activeBtn.classList.add('active');
        }
        
        // Show/hide controls based on mode
        const controlsGroup = document.getElementById('controlsGroup');
        const onchainControls = document.getElementById('onchainControlsGroup');
        const datasetSelect = document.getElementById('datasetSelect');
        
        if (mode === 'onchain') {
          controlsGroup.style.display = 'none';
          onchainControls.style.display = 'flex';
          // Pre-fill contract address
          document.getElementById('onchainContractInput').value = CONTRACT_ADDRESS;
        } else {
          controlsGroup.style.display = 'flex';
          onchainControls.style.display = 'none';
          datasetSelect.style.display = mode === 'test' ? 'block' : 'none';
        }
        
        // Clear existing charts
        if (chart) {
          chart.destroy();
          chart = null;
        }
        if (barChart) {
          barChart.destroy();
          barChart = null;
        }
        if (candlestickChart) {
          candlestickChart.destroy();
          candlestickChart = null;
        }
        
        if (mode === 'onchain') {
          // Reset display for on-chain
          document.getElementById('scoreValue').textContent = '--';
          document.getElementById('scoreValue').className = 'value neutral';
          document.getElementById('sentimentBadge').textContent = 'Connect Wallet';
          document.getElementById('sentimentBadge').className = 'badge neutral';
          document.getElementById('sampleSize').textContent = '--';
          document.getElementById('rawScore').textContent = '--';
          document.getElementById('engine').textContent = 'On-Chain';
          document.getElementById('latestNews').innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">Connect wallet & enter contract address to view on-chain data</div>';
          document.getElementById('mostBullish').innerHTML = '<div class="news-title">Connect wallet to load</div><div class="news-meta"><span>--</span><span class="news-score bullish">--</span></div>';
          document.getElementById('mostBearish').innerHTML = '<div class="news-title">Connect wallet to load</div><div class="news-meta"><span>--</span><span class="news-score bearish">--</span></div>';
          // Auto-fetch if wallet already connected and contract address saved
          if (onchainWalletAddr && CONTRACT_ADDRESS) {
            await fetchOnChainData();
          }
        } else {
          // Fetch new data for test/live mode
          await fetchScore();
          await fetchHistory();
        }
      }

      function switchChartType(type) {
        currentChartType = type;
        
        // Update buttons
        document.querySelectorAll('.chart-btn').forEach(btn => {
          btn.classList.remove('active');
          if (btn.dataset.chart === type) {
            btn.classList.add('active');
          }
        });
        
        // Show/hide chart wrappers
        document.querySelectorAll('.chart-wrapper').forEach(wrapper => {
          wrapper.classList.remove('active');
        });
        document.getElementById(`${type}ChartWrapper`).classList.add('active');
      }

      async function triggerAnalysis() {
        const btn = document.getElementById('analyzeBtn');
        btn.disabled = true;
        btn.textContent = 'Analyzing...';
        
        try {
          const intervalValue = document.getElementById('intervalSelect').value;
          
          const payload = {
            mode: currentMode,
            dataset: currentDataset,
            interval: intervalValue
          };
          
          const response = await fetch('/api/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          
          const data = await response.json();
          
          if (data.error) {
            alert('Error: ' + data.error);
          } else {
            await fetchScore();
            await fetchHistory();
          }
        } catch (error) {
          console.error('Error triggering analysis:', error);
          alert('Failed to trigger analysis');
        } finally {
          btn.disabled = false;
          btn.textContent = 'Analyze Now';
        }
      }

      function startAutoRefresh() {
        if (autoRefreshInterval) return;
        
        // Get selected interval
        const intervalValue = document.getElementById('intervalSelect').value;
        const intervalMap = {
          '30s': 30000,
          '1min': 60000,
          '2min': 120000,
          '5min': 300000,
          '10min': 600000,
          '30min': 1800000,
          '1hr': 3600000
        };
        
        const intervalMs = intervalMap[intervalValue] || 60000;
        
        // Run analysis at selected interval
        autoRefreshInterval = setInterval(async () => {
          await triggerAnalysis();
        }, intervalMs);
        
        // Run immediately
        triggerAnalysis();
      }

      function stopAutoRefresh() {
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
        }
      }

      // Live mode automation functions
      let realtimeNewsInterval = null;
      let lastLiveHistoryLen = 0;

      async function startLiveAutomation() {
        const intervalValue = document.getElementById('intervalSelect').value;
        lastLiveHistoryLen = 0; // reset tracker
        
        try {
          const response = await fetch('/api/live/automation', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'start',
              interval: intervalValue,
              query: 'crypto OR bitcoin OR ethereum'
            })
          });
          
          const data = await response.json();
          
          if (data.error) {
            alert('Error: ' + data.error);
            document.getElementById('autoToggle').checked = false;
            return;
          }
          
          console.log('Live automation started:', data);
          startRealtimeNewsPolling();
          
        } catch (error) {
          console.error('Error starting live automation:', error);
          alert('Failed to start live automation');
          document.getElementById('autoToggle').checked = false;
        }
      }

      async function stopLiveAutomation() {
        try {
          const response = await fetch('/api/live/automation', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'stop' })
          });
          
          const data = await response.json();
          console.log('Live automation stopped:', data);
          
          // Stop polling
          stopRealtimeNewsPolling();
          
        } catch (error) {
          console.error('Error stopping live automation:', error);
        }
      }

      function startRealtimeNewsPolling() {
        if (realtimeNewsInterval) return;
        
        realtimeNewsInterval = setInterval(async () => {
          try {
            // 1. Fetch live status (progress, countdown, buffer count)
            const statusResp = await fetch('/api/live/status');
            const status = await statusResp.json();

            if (status.active) {
              const statusText = document.getElementById('statusText');
              const counterText = document.getElementById('counterText');
              const remaining = Math.round(status.remaining_seconds);
              const total = status.interval_seconds || 1;
              const elapsed = Math.round(status.elapsed_seconds);
              const pct = Math.min(100, Math.round((elapsed / total) * 100));
              const buf = status.articles_in_buffer;

              if (remaining > 0 && buf < 30) {
                statusText.textContent = `● Collecting... ${remaining}s left (need ${30 - buf} more)`;
              } else if (remaining > 0) {
                statusText.textContent = `● Collecting... ${remaining}s left`;
              } else if (buf < 30) {
                statusText.textContent = `● Waiting for min 30 articles (${buf} so far)...`;
              } else {
                statusText.textContent = `● Sampling & analyzing...`;
              }
              counterText.textContent = `${buf}/120 collected | sampling 25 at end | ${pct}%`;

              // 2. Detect new interval score → refresh charts & score
              if (status.total_scores > lastLiveHistoryLen) {
                lastLiveHistoryLen = status.total_scores;
                await fetchScore();
                await fetchHistory();
              }
            }

            // 3. Fetch real-time news feed
            await fetchRealtimeNews();

          } catch (error) {
            console.error('Polling error:', error);
          }
        }, 3000);
        
        // Run once immediately
        fetchRealtimeNews();
      }

      function stopRealtimeNewsPolling() {
        if (realtimeNewsInterval) {
          clearInterval(realtimeNewsInterval);
          realtimeNewsInterval = null;
        }
      }

      async function fetchRealtimeNews() {
        try {
          const response = await fetch('/api/live/realtime-news');
          const data = await response.json();
          
          if (data.news && data.news.length > 0) {
            updateLatestNewsRealtime(data.news);
          }
        } catch (error) {
          console.error('Error fetching real-time news:', error);
        }
      }

      async function fetchScore() {
        try {
          // Add timestamp to prevent caching
          const response = await fetch(`/api/score?mode=${currentMode}&_t=${Date.now()}`);
          const data = await response.json();
          
          console.log(`Fetched score for ${currentMode} mode:`, data.score, data.classification);
          
          if (data.error) {
            console.error(data.error);
            return;
          }

          // Update score
          const scoreEl = document.getElementById('scoreValue');
          scoreEl.textContent = data.score.toFixed(1);
          
          // Update sentiment class
          const sentiment = data.classification.toLowerCase();
          scoreEl.className = `value ${sentiment}`;
          
          // Update badge
          const badge = document.getElementById('sentimentBadge');
          badge.textContent = data.classification;
          badge.className = `badge ${sentiment}`;
          
          // Update details
          document.getElementById('sampleSize').textContent = data.sample_size || '--';
          document.getElementById('rawScore').textContent = data.raw_score ? data.raw_score.toFixed(2) : '--';
          document.getElementById('engine').textContent = data.nlp_engine || '--';
          
          // Update news items
          updateNewsItems(data);
          
        } catch (error) {
          console.error('Error fetching score:', error);
        }
      }

      function updateNewsItems(data) {
        // Most Bullish
        if (data.highest_tweet) {
          const bullishEl = document.getElementById('mostBullish');
          bullishEl.innerHTML = `
            <div class="news-title">${truncateText(data.highest_tweet.text, 80)}</div>
            <div class="news-meta">
              <span>${data.highest_tweet.label}</span>
              <span class="news-score bullish">${data.highest_tweet.score.toFixed(1)}</span>
            </div>
          `;
        }
        
        // Most Bearish
        if (data.lowest_tweet) {
          const bearishEl = document.getElementById('mostBearish');
          bearishEl.innerHTML = `
            <div class="news-title">${truncateText(data.lowest_tweet.text, 80)}</div>
            <div class="news-meta">
              <span>${data.lowest_tweet.label}</span>
              <span class="news-score bearish">${data.lowest_tweet.score.toFixed(1)}</span>
            </div>
          `;
        }
      }

      async function fetchHistory() {
        try {
          // Add timestamp to prevent caching
          const response = await fetch(`/api/history?mode=${currentMode}&_t=${Date.now()}`);
          const data = await response.json();
          
          console.log(`Fetched history for ${currentMode} mode:`, data.history?.length || 0, 'items');
          
          if (data.history && data.history.length > 0) {
            updateCharts(data.history);
            updateLatestNews(data.history);
          } else {
            // Clear charts if no data
            console.log(`No history data for ${currentMode} mode - clearing charts`);
            if (chart) chart.destroy();
            if (barChart) barChart.destroy();
            if (candlestickChart) candlestickChart.destroy();
            chart = barChart = candlestickChart = null;
          }
        } catch (error) {
          console.error('Error fetching history:', error);
        }
      }

      function updateCharts(history) {
        console.log(`[${currentMode.toUpperCase()}] Updating charts with ${history.length} data points`);
        updateLineChart(history);
        updateBarChart(history);
        updateCandlestickChart(history);
      }

      function updateLineChart(history) {
        const ctx = document.getElementById('trendChart').getContext('2d');
        
        const labels = history.map(h => new Date(h.timestamp).toLocaleTimeString());
        const scores = history.map(h => h.score);
        
        if (chart) {
          chart.destroy();
        }
        
        chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Sentiment Score',
              data: scores,
              borderColor: 'rgb(59, 130, 246)',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              tension: 0.4,
              fill: true,
              pointRadius: 4,
              pointHoverRadius: 6,
              pointBackgroundColor: 'rgb(59, 130, 246)',
              pointBorderColor: '#fff',
              pointBorderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                grid: {
                  color: 'rgba(100, 120, 180, 0.1)'
                },
                ticks: {
                  color: '#94a3b8'
                }
              },
              x: {
                grid: {
                  color: 'rgba(100, 120, 180, 0.1)'
                },
                ticks: {
                  color: '#94a3b8',
                  maxRotation: 45,
                  minRotation: 45
                }
              }
            }
          }
        });
      }

      function updateBarChart(history) {
        const ctx = document.getElementById('barChart').getContext('2d');
        
        if (history.length === 0) {
          return;
        }
        
        // Count sentiment classifications
        const counts = { Bullish: 0, Neutral: 0, Bearish: 0 };
        history.forEach(h => {
          if (h.classification in counts) {
            counts[h.classification]++;
          }
        });
        
        if (barChart) {
          barChart.destroy();
        }
        
        barChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['Bullish', 'Neutral', 'Bearish'],
            datasets: [{
              label: 'Sentiment Count',
              data: [counts.Bullish, counts.Neutral, counts.Bearish],
              backgroundColor: [
                'rgba(34, 197, 94, 0.7)',
                'rgba(245, 158, 11, 0.7)',
                'rgba(239, 68, 68, 0.7)'
              ],
              borderColor: [
                'rgb(34, 197, 94)',
                'rgb(245, 158, 11)',
                'rgb(239, 68, 68)'
              ],
              borderWidth: 2,
              borderRadius: 8
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                labels: {
                  color: '#94a3b8',
                  font: {
                    size: 12
                  }
                }
              },
              tooltip: {
                backgroundColor: 'rgba(15, 23, 42, 0.9)',
                titleColor: '#e2e8f0',
                bodyColor: '#94a3b8',
                borderColor: 'rgba(100, 120, 180, 0.3)',
                borderWidth: 1,
                padding: 12,
                displayColors: true
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  color: 'rgba(100, 120, 180, 0.1)'
                },
                ticks: {
                  color: '#94a3b8',
                  stepSize: 1,
                  font: {
                    size: 11
                  }
                }
              },
              x: {
                grid: {
                  display: false
                },
                ticks: {
                  color: '#94a3b8',
                  font: {
                    size: 12,
                    weight: 600
                  }
                }
              }
            }
          }
        });
      }

      function updateCandlestickChart(history) {
        const ctx = document.getElementById('candlestickChart').getContext('2d');
        
        if (history.length === 0) {
          return;
        }
        
        // Build OHLC data from sentiment history
        // open = previous close (or same as close for first), close = current score
        // high/low add slight variance from raw_score to simulate real candle wicks
        const ohlcData = [];
        
        for (let i = 0; i < history.length; i++) {
          const current = history[i];
          const prev = i > 0 ? history[i - 1] : current;
          
          const open = prev.score;
          const close = current.score;
          const raw = current.raw_score != null ? current.raw_score : close;
          
          // Wicks extend to the extremes of open, close, raw_score + small random jitter
          const jitter = (Math.abs(close - open) * 0.15) + 1.5;
          const high = Math.min(100, Math.max(open, close, raw) + jitter);
          const low  = Math.max(0,   Math.min(open, close, raw) - jitter);
          
          const ts = luxon.DateTime.fromISO(current.timestamp).isValid
            ? luxon.DateTime.fromISO(current.timestamp)
            : luxon.DateTime.fromJSDate(new Date(current.timestamp));
          
          ohlcData.push({
            x: ts.toMillis(),
            o: open,
            h: high,
            l: low,
            c: close
          });
        }
        
        if (candlestickChart) {
          candlestickChart.destroy();
        }
        
        candlestickChart = new Chart(ctx, {
          type: 'candlestick',
          data: {
            datasets: [{
              label: 'Sentiment OHLC',
              data: ohlcData,
              color: {
                up: 'rgba(34, 197, 94, 1)',      // bullish body border
                down: 'rgba(239, 68, 68, 1)',     // bearish body border
                unchanged: 'rgba(148, 163, 184, 1)'
              },
              backgroundColors: {
                up: 'rgba(34, 197, 94, 0.85)',    // bullish fill
                down: 'rgba(239, 68, 68, 0.85)',  // bearish fill
                unchanged: 'rgba(148, 163, 184, 0.5)'
              },
              borderColor: {
                up: 'rgb(34, 197, 94)',
                down: 'rgb(239, 68, 68)',
                unchanged: 'rgb(148, 163, 184)'
              }
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                backgroundColor: 'rgba(15, 23, 42, 0.95)',
                titleColor: '#e2e8f0',
                bodyColor: '#94a3b8',
                borderColor: 'rgba(100, 120, 180, 0.3)',
                borderWidth: 1,
                padding: 12,
                displayColors: false,
                callbacks: {
                  title: function(tooltipItems) {
                    const d = luxon.DateTime.fromMillis(tooltipItems[0].parsed.x);
                    return d.toFormat('HH:mm:ss');
                  },
                  label: function(context) {
                    const o = context.parsed.o;
                    const h = context.parsed.h;
                    const l = context.parsed.l;
                    const c = context.parsed.c;
                    const dir = c >= o ? '▲ Bullish' : '▼ Bearish';
                    return [
                      `Open:  ${o.toFixed(1)}`,
                      `High:  ${h.toFixed(1)}`,
                      `Low:   ${l.toFixed(1)}`,
                      `Close: ${c.toFixed(1)}`,
                      ``,
                      dir
                    ];
                  }
                }
              }
            },
            scales: {
              x: {
                type: 'timeseries',
                time: {
                  unit: 'minute',
                  displayFormats: {
                    minute: 'HH:mm',
                    hour: 'HH:mm'
                  },
                  tooltipFormat: 'HH:mm:ss'
                },
                ticks: {
                  color: '#94a3b8',
                  maxRotation: 45,
                  minRotation: 0,
                  font: { size: 10 },
                  source: 'data',
                  autoSkip: true,
                  maxTicksLimit: 12
                },
                grid: {
                  color: 'rgba(100, 120, 180, 0.08)'
                }
              },
              y: {
                min: 0,
                max: 100,
                grid: {
                  color: 'rgba(100, 120, 180, 0.1)'
                },
                ticks: {
                  color: '#94a3b8',
                  font: { size: 11 },
                  stepSize: 10,
                  callback: function(value) {
                    if (value === 50) return '50 — Neutral';
                    return value;
                  }
                }
              }
            }
          }
        });
      }

      function updateLatestNews(history) {
        const newsContainer = document.getElementById('latestNews');
        
        if (history.length === 0) {
          newsContainer.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">No data available</div>';
          return;
        }
        
        const recentItems = history.slice(-10).reverse();
        
        newsContainer.innerHTML = recentItems.map(item => `
          <div class="news-article">
            <div class="article-title">
              Score: ${item.score.toFixed(1)} - ${item.classification} (${item.sample_size} samples)
            </div>
            <div class="article-time">${new Date(item.timestamp).toLocaleString()}</div>
          </div>
        `).join('');
      }

      function updateLatestNewsRealtime(newsArticles) {
        const newsContainer = document.getElementById('latestNews');
        
        if (!newsArticles || newsArticles.length === 0) {
          newsContainer.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">Waiting for news...</div>';
          return;
        }
        
        const recentNews = newsArticles.slice(0, 25);
        
        newsContainer.innerHTML = recentNews.map((article, index) => {
          const isAnalyzed = article.analyzed === true && article.sentiment;
          const isSampled  = article.sampled === true;

          // Colours based on analysis state
          let borderColor = 'var(--border)';          // default: grey
          let sentimentHTML = '<span style="color: var(--text-muted); font-size: 0.8rem; font-style: italic;">Pending…</span>';

          if (isAnalyzed) {
            const label = article.sentiment.label;
            borderColor = label === 'positive' ? 'var(--accent-bullish)' :
                          label === 'negative' ? 'var(--accent-bearish)' :
                          'var(--accent-neutral)';
            sentimentHTML = `<span style="color: ${borderColor}; font-weight: 600; font-size: 0.85rem;">${article.score.toFixed(1)} – ${label.toUpperCase()}</span>`;
          }

          const sampledBadge = isSampled
            ? '<span style="background: rgba(59,130,246,0.2); color: var(--accent-blue); padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-left: 6px;">SAMPLED</span>'
            : '';

          const timeAgo = getTimeAgo(new Date(article.timestamp));
          const isNew = (new Date() - new Date(article.timestamp)) < 5000;
          const pulseStyle = isNew ? 'animation: pulse 0.5s ease-in-out;' : '';

          return `
            <div class="news-article" style="${pulseStyle} border-left: 3px solid ${borderColor}; padding: 8px 12px; margin-bottom: 6px;">
              <div class="article-title" style="display: flex; align-items: flex-start;">
                <span style="color: var(--text-muted); font-size: 0.75rem; margin-right: 8px; flex-shrink: 0;">#${index + 1}</span>
                <span>${truncateText(article.text, 120)}</span>
                ${sampledBadge}
              </div>
              <div class="article-time" style="display: flex; justify-content: space-between; align-items: center; margin-top: 4px;">
                <span style="font-size: 0.75rem;">${timeAgo}</span>
                ${sentimentHTML}
              </div>
            </div>
          `;
        }).join('');
      }

      function getTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        
        if (seconds < 60) return `${seconds}s ago`;
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `${minutes}m ago`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours}h ago`;
        return date.toLocaleDateString();
      }

      function truncateText(text, maxLength) {
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
      }

      // ── On-Chain Mode ──────────────────────────────────────────

      let onchainProvider = null;
      let onchainSigner = null;
      let onchainWalletAddr = null;
      let onchainContract = null;
      let onchainSubmissions = [];

      async function connectOnChainWallet() {
        const btn = document.getElementById('walletConnectBtn');
        const badge = document.getElementById('walletBadge');
        const statusText = document.getElementById('onchainStatusText');

        if (!window.ethereum) {
          alert('MetaMask not detected. Install MetaMask to use On-Chain mode.');
          return false;
        }

        try {
          btn.disabled = true;
          btn.innerHTML = 'Connecting...';

          const provider = new ethers.BrowserProvider(window.ethereum);
          await provider.send('eth_requestAccounts', []);

          // Check network — should be Polygon Amoy (80002)
          const network = await provider.getNetwork();
          if (Number(network.chainId) !== 80002) {
            statusText.textContent = '⚠ Switch to Polygon Amoy (80002)';
            statusText.style.color = 'var(--accent-bearish)';
            try {
              await window.ethereum.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: '0x13882' }]
              });
            } catch (switchErr) {
              if (switchErr.code === 4902) {
                await window.ethereum.request({
                  method: 'wallet_addEthereumChain',
                  params: [{
                    chainId: '0x13882',
                    chainName: 'Polygon Amoy Testnet',
                    nativeCurrency: { name: 'POL', symbol: 'POL', decimals: 18 },
                    rpcUrls: ['https://rpc-amoy.polygon.technology'],
                    blockExplorerUrls: ['https://amoy.polygonscan.com']
                  }]
                });
              } else {
                throw switchErr;
              }
            }
          }

          const signer = await provider.getSigner();
          onchainProvider = provider;
          onchainSigner = signer;
          onchainWalletAddr = await signer.getAddress();

          btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg> Connected';
          btn.classList.add('connected');
          badge.style.display = 'block';
          badge.textContent = onchainWalletAddr.slice(0, 6) + '...' + onchainWalletAddr.slice(-4);
          statusText.textContent = 'Amoy testnet';
          statusText.style.color = 'var(--accent-bullish)';

          return true;
        } catch (err) {
          console.error('Wallet connect error:', err);
          btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg> Connect Wallet';
          statusText.textContent = err.code === 4001 ? 'Connection rejected' : 'Connection failed';
          statusText.style.color = 'var(--accent-bearish)';
          return false;
        } finally {
          btn.disabled = false;
        }
      }

      async function fetchOnChainData() {
        const statusText = document.getElementById('onchainStatusText');
        const refreshBtn = document.getElementById('onchainRefreshBtn');

        // Get contract address (hardcoded or from input override)
        let contractAddr = document.getElementById('onchainContractInput').value.trim() || CONTRACT_ADDRESS;
        if (!contractAddr) {
          statusText.textContent = 'No contract address configured';
          statusText.style.color = 'var(--accent-bearish)';
          return;
        }

        // Validate address format
        if (!/^0x[a-fA-F0-9]{40}$/.test(contractAddr)) {
          statusText.textContent = 'Invalid address format';
          statusText.style.color = 'var(--accent-bearish)';
          return;
        }

        document.getElementById('onchainContractInput').value = contractAddr;

        // Connect wallet if not connected
        if (!onchainSigner) {
          const connected = await connectOnChainWallet();
          if (!connected) return;
        }

        refreshBtn.disabled = true;
        refreshBtn.textContent = 'Loading...';
        statusText.textContent = 'Reading contract...';
        statusText.style.color = 'var(--accent-blue)';

        // Show loading in the panels
        document.getElementById('latestNews').innerHTML = '<div class="onchain-loading"><div class="spinner"></div>Reading on-chain data...</div>';

        try {
          onchainContract = new ethers.Contract(contractAddr, SENTIMENT_ORACLE_ABI, onchainSigner);

          const total = await onchainContract.getTotalSubmissions();
          const totalNum = Number(total);

          if (totalNum === 0) {
            statusText.textContent = 'Contract has 0 submissions';
            statusText.style.color = 'var(--accent-neutral)';
            document.getElementById('scoreValue').textContent = '--';
            document.getElementById('scoreValue').className = 'value neutral';
            document.getElementById('sentimentBadge').textContent = 'No Data';
            document.getElementById('sentimentBadge').className = 'badge neutral';
            document.getElementById('sampleSize').textContent = '0';
            document.getElementById('rawScore').textContent = '--';
            document.getElementById('engine').textContent = 'On-Chain';
            document.getElementById('latestNews').innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">No submissions yet. Use the Contribute button (in Test/Live mode) to push a score on-chain!</div>';
            return;
          }

          // Read last 50 submissions (or all if fewer)
          const maxRead = 50;
          const startIdx = Math.max(0, totalNum - maxRead);
          onchainSubmissions = [];

          statusText.textContent = `Reading ${totalNum - startIdx} of ${totalNum} submissions...`;

          // Batch reads in groups of 10 for speed
          for (let i = startIdx; i < totalNum; i += 10) {
            const batch = [];
            for (let j = i; j < Math.min(i + 10, totalNum); j++) {
              batch.push(onchainContract.getSentiment(j));
            }
            const results = await Promise.all(batch);
            for (let k = 0; k < results.length; k++) {
              const [score, timestamp, contributor] = results[k];
              onchainSubmissions.push({
                index: i + k,
                score: Number(score),
                timestamp: Number(timestamp),
                contributor: contributor
              });
            }
            statusText.textContent = `Read ${onchainSubmissions.length} / ${totalNum - startIdx}...`;
          }

          updateOnChainDisplay(totalNum);
          statusText.textContent = `${totalNum} total submissions | showing last ${onchainSubmissions.length}`;
          statusText.style.color = 'var(--accent-bullish)';

        } catch (err) {
          console.error('On-chain read error:', err);
          statusText.textContent = 'Error: ' + (err.shortMessage || err.message || 'Unknown error');
          statusText.style.color = 'var(--accent-bearish)';
          document.getElementById('latestNews').innerHTML = '<div style="text-align: center; color: var(--accent-bearish); padding: 20px;">Failed to read contract. Check the address and try again.</div>';
        } finally {
          refreshBtn.disabled = false;
          refreshBtn.textContent = 'Refresh';
        }
      }

      function updateOnChainDisplay(totalSubmissions) {
        if (onchainSubmissions.length === 0) return;

        const latest = onchainSubmissions[onchainSubmissions.length - 1];
        const avgScore = onchainSubmissions.reduce((a, b) => a + b.score, 0) / onchainSubmissions.length;
        const uniqueContributors = new Set(onchainSubmissions.map(s => s.contributor)).size;

        // Score card
        const scoreEl = document.getElementById('scoreValue');
        scoreEl.textContent = latest.score;
        const cls = latest.score >= 60 ? 'bullish' : latest.score <= 40 ? 'bearish' : 'neutral';
        const clsLabel = latest.score >= 60 ? 'Bullish' : latest.score <= 40 ? 'Bearish' : 'Neutral';
        scoreEl.className = 'value ' + cls;

        // Badge
        const badge = document.getElementById('sentimentBadge');
        badge.textContent = clsLabel;
        badge.className = 'badge ' + cls;

        // Details
        document.getElementById('sampleSize').textContent = totalSubmissions + ' on-chain';
        document.getElementById('rawScore').textContent = avgScore.toFixed(1) + ' avg';
        document.getElementById('engine').textContent = uniqueContributors + ' contributor' + (uniqueContributors !== 1 ? 's' : '');

        // Build chart history
        const history = onchainSubmissions.map(s => ({
          score: s.score,
          timestamp: new Date(s.timestamp * 1000).toISOString(),
          classification: s.score >= 60 ? 'Bullish' : s.score <= 40 ? 'Bearish' : 'Neutral',
          raw_score: s.score,
          sample_size: 1
        }));
        updateCharts(history);

        // Extremes
        const sorted = [...onchainSubmissions].sort((a, b) => b.score - a.score);
        const highest = sorted[0];
        const lowest = sorted[sorted.length - 1];

        document.getElementById('mostBullish').innerHTML = `
          <div class="news-title">Score ${highest.score} by ${highest.contributor.slice(0,6)}...${highest.contributor.slice(-4)}</div>
          <div class="news-meta">
            <span>${new Date(highest.timestamp * 1000).toLocaleString()}</span>
            <span class="news-score bullish">${highest.score}</span>
          </div>`;

        document.getElementById('mostBearish').innerHTML = `
          <div class="news-title">Score ${lowest.score} by ${lowest.contributor.slice(0,6)}...${lowest.contributor.slice(-4)}</div>
          <div class="news-meta">
            <span>${new Date(lowest.timestamp * 1000).toLocaleString()}</span>
            <span class="news-score bearish">${lowest.score}</span>
          </div>`;

        // Submissions list
        updateOnChainNewsList();
      }

      function updateOnChainNewsList() {
        const container = document.getElementById('latestNews');

        if (onchainSubmissions.length === 0) {
          container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">No on-chain submissions yet</div>';
          return;
        }

        const recent = [...onchainSubmissions].reverse().slice(0, 30);

        container.innerHTML = recent.map((sub, i) => {
          const color = sub.score >= 60 ? 'var(--accent-bullish)' : sub.score <= 40 ? 'var(--accent-bearish)' : 'var(--accent-neutral)';
          const label = sub.score >= 60 ? 'BULLISH' : sub.score <= 40 ? 'BEARISH' : 'NEUTRAL';
          const time = new Date(sub.timestamp * 1000).toLocaleString();
          const addr = sub.contributor.slice(0, 6) + '...' + sub.contributor.slice(-4);
          const isYou = onchainWalletAddr && sub.contributor.toLowerCase() === onchainWalletAddr.toLowerCase();
          const youBadge = isYou ? '<span style="background: rgba(59,130,246,0.2); color: var(--accent-blue); padding: 1px 6px; border-radius: 4px; font-size: 0.7rem; margin-left: 6px;">YOU</span>' : '';

          return `
            <div class="news-article" style="border-left: 3px solid ${color}; padding: 10px 12px; margin-bottom: 6px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 10px;">
                  <span style="font-size: 1.5rem; font-weight: 900; color: ${color};">${sub.score}</span>
                  <span style="font-size: 0.75rem; font-weight: 600; color: ${color};">${label}</span>
                </div>
                <div style="text-align: right;">
                  <div style="font-family: monospace; font-size: 0.75rem; color: var(--accent-blue);">
                    <a href="https://amoy.polygonscan.com/address/${sub.contributor}" target="_blank" style="color: var(--accent-blue); text-decoration: none;">${addr}</a>${youBadge}
                  </div>
                  <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 2px;">${time}</div>
                </div>
              </div>
            </div>`;
        }).join('');
      }

      // ── Contribute Flow ────────────────────────────────────────

      // Contract ABI (matches CommunitySentimentOracle.sol)
      const SENTIMENT_ORACLE_ABI = [
        "function submitSentiment(uint256 _score) external",
        "function getSentiment(uint256 index) external view returns (uint256 score, uint256 timestamp, address contributor)",
        "function getTotalSubmissions() external view returns (uint256)",
        "function lastSubmissionTime(address) external view returns (uint256)"
      ];

      // Deployed CommunitySentimentOracle on Polygon Amoy
      const CONTRACT_ADDRESS = '0xDa78C384B2F773568A678bA248faa50C92BE7127';

      let contributeScanScore = null;
      let contributeScanPolling = null;

      document.getElementById('contributeBtn').addEventListener('click', startContribute);
      document.getElementById('contributeModalClose').addEventListener('click', closeContributeModal);
      document.getElementById('contribCancelBtn').addEventListener('click', cancelContribute);
      document.getElementById('contribPushBtn').addEventListener('click', pushScoreOnChain);
      document.getElementById('contribDismissBtn').addEventListener('click', closeContributeModal);

      // Close modal on backdrop click
      document.getElementById('contributeModal').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) closeContributeModal();
      });

      async function startContribute() {
        const modal = document.getElementById('contributeModal');
        modal.style.display = 'flex';

        // Reset UI to step 1
        document.getElementById('contribStep1').style.display = 'block';
        document.getElementById('contribStep2').style.display = 'none';
        document.getElementById('contribStep3').style.display = 'none';
        document.getElementById('contribProgressFill').style.width = '0%';
        document.getElementById('contribProgressFill').style.background = 'linear-gradient(90deg, #7c3aed, #a78bfa)';
        document.getElementById('contribPhaseText').textContent = 'Scanning multiple crypto sources...';
        document.getElementById('contribStats').textContent = '0 unique articles collected';
        contributeScanScore = null;

        // Start backend scan
        try {
          const resp = await fetch('/api/contribute/start', { method: 'POST' });
          const data = await resp.json();
          if (data.error) {
            alert('Error: ' + data.error);
            closeContributeModal();
            return;
          }
        } catch(e) {
          alert('Failed to start scan');
          closeContributeModal();
          return;
        }

        // Poll progress (every 1.5s for faster feedback)
        contributeScanPolling = setInterval(pollContributeStatus, 1500);
      }

      async function pollContributeStatus() {
        try {
          const resp = await fetch('/api/contribute/status');
          const s = await resp.json();

          // Progress based on message content (backend reports X/6 sources)
          const sourceMatch = s.message.match(/(\d+)\/(\d+) sources/);
          let pct = 0;
          if (s.phase === 'analyzing') {
            pct = 90;
          } else if (sourceMatch) {
            pct = Math.round((parseInt(sourceMatch[1]) / parseInt(sourceMatch[2])) * 80);
          } else {
            pct = Math.min(80, Math.round((s.elapsed / 40) * 80));
          }
          document.getElementById('contribProgressFill').style.width = pct + '%';
          document.getElementById('contribPhaseText').textContent = s.message || 'Scanning...';
          document.getElementById('contribStats').textContent = `${s.articles} unique articles · ${s.elapsed}s elapsed`;

          if (s.phase === 'done' && s.result && s.result.score != null) {
            clearInterval(contributeScanPolling);
            contributeScanPolling = null;
            contributeScanScore = s.result.score;
            showContributeResult(s.result);
          } else if (s.phase === 'error' || s.phase === 'cancelled') {
            clearInterval(contributeScanPolling);
            contributeScanPolling = null;
            document.getElementById('contribProgressFill').style.width = '100%';
            document.getElementById('contribProgressFill').style.background = 'linear-gradient(90deg, #ef4444, #dc2626)';
            document.getElementById('contribPhaseText').textContent = s.message || 'Scan failed';
            document.getElementById('contribStats').textContent = s.phase === 'cancelled' ? 'Cancelled by user' : 'Try again — click the button once more';
          }
        } catch(e) {
          console.error('Contribute poll error:', e);
        }
      }

      function showContributeResult(result) {
        document.getElementById('contribStep1').style.display = 'none';
        document.getElementById('contribStep2').style.display = 'block';

        const score = result.score;
        const cls = score >= 60 ? 'bullish' : score <= 40 ? 'bearish' : 'neutral';
        document.getElementById('contribScoreValue').textContent = score.toFixed(1);
        const label = document.getElementById('contribScoreLabel');
        label.textContent = result.classification;
        label.className = 'contrib-score-label ' + cls;
        document.getElementById('contribResultIcon').textContent = cls === 'bullish' ? '\uD83D\uDE80' : cls === 'bearish' ? '\uD83D\uDCC9' : '\u2696\uFE0F';
        document.getElementById('contribMeta').textContent = `${result.sample_size} sampled / ${result.total_collected} collected \u00b7 ${result.engine}`;
      }

      async function pushScoreOnChain() {
        const btn = document.getElementById('contribPushBtn');
        const step2 = document.getElementById('contribStep2');
        const step3 = document.getElementById('contribStep3');
        const txText = document.getElementById('contribTxText');
        const txIcon = document.getElementById('contribTxIcon');
        const txHash = document.getElementById('contribTxHash');

        if (contributeScanScore == null) { alert('No score available'); return; }

        // Use hardcoded contract address
        let contractAddr = CONTRACT_ADDRESS;

        step2.style.display = 'none';
        step3.style.display = 'block';
        txText.textContent = 'Connecting wallet...';
        txIcon.textContent = '\uD83D\uDD17';
        txHash.style.display = 'none';

        try {
          // Connect MetaMask
          if (!window.ethereum) {
            txText.textContent = 'MetaMask not detected. Install MetaMask to continue.';
            txIcon.textContent = '\u274C';
            return;
          }

          const provider = new ethers.BrowserProvider(window.ethereum);
          await provider.send('eth_requestAccounts', []);
          const signer = await provider.getSigner();
          const addr = await signer.getAddress();

          txText.textContent = `Wallet: ${addr.slice(0,6)}...${addr.slice(-4)} — sending tx...`;
          txIcon.textContent = '\u23F3';

          // Create contract instance
          const contract = new ethers.Contract(contractAddr, SENTIMENT_ORACLE_ABI, signer);

          // Call submitSentiment with the integer score (0-100)
          const scoreInt = Math.round(contributeScanScore);
          const tx = await contract.submitSentiment(scoreInt);

          txText.textContent = 'Transaction submitted — waiting for confirmation...';
          txHash.style.display = 'block';
          txHash.innerHTML = `Tx: <a href="https://amoy.polygonscan.com/tx/${tx.hash}" target="_blank" style="color:var(--accent-blue);">${tx.hash}</a>`;

          const receipt = await tx.wait();

          txIcon.textContent = '\u2705';
          txText.textContent = `Score ${scoreInt} pushed on-chain! Block #${receipt.blockNumber}`;
          txHash.innerHTML = `Tx: <a href="https://amoy.polygonscan.com/tx/${tx.hash}" target="_blank" style="color:var(--accent-blue);">${tx.hash}</a>`;

        } catch(err) {
          console.error('On-chain push error:', err);
          txIcon.textContent = '\u274C';
          if (err.code === 'ACTION_REJECTED' || err.code === 4001) {
            txText.textContent = 'Transaction rejected by user';
          } else if (err.message && err.message.includes('Wait before submitting')) {
            txText.textContent = 'Cooldown active — wait 60s between submissions';
          } else {
            txText.textContent = `Error: ${err.shortMessage || err.message || 'Unknown error'}`;
          }
        }
      }

      async function cancelContribute() {
        if (contributeScanPolling) {
          clearInterval(contributeScanPolling);
          contributeScanPolling = null;
        }
        try { await fetch('/api/contribute/cancel', { method: 'POST' }); } catch(e) {}
        closeContributeModal();
      }

      function closeContributeModal() {
        document.getElementById('contributeModal').style.display = 'none';
        if (contributeScanPolling) {
          clearInterval(contributeScanPolling);
          contributeScanPolling = null;
          fetch('/api/contribute/cancel', { method: 'POST' }).catch(() => {});
        }
      }

      // Initialize on load
      init();
    </script>
  </body>
</html>

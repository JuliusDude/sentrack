<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SenTrack — Sentiment Oracle</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.1/dist/chartjs-chart-financial.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --bg-primary: #0a0e17;
        --bg-card: rgba(15, 23, 42, 0.7);
        --border: rgba(100, 120, 180, 0.15);
        --text-primary: #e2e8f0;
        --text-secondary: #94a3b8;
        --text-muted: #64748b;
        --accent-bullish: #22c55e;
        --accent-bearish: #ef4444;
        --accent-neutral: #f59e0b;
        --accent-blue: #3b82f6;
      }

      body {
        font-family: "Inter", -apple-system, sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      /* Header */
      .header {
        text-align: center;
        padding: 30px 0;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        margin-bottom: 20px;
        backdrop-filter: blur(20px);
      }

      .header h1 {
        font-size: 2.5rem;
        font-weight: 800;
        background: linear-gradient(135deg, #e2e8f0, #3b82f6, #8b5cf6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        letter-spacing: -0.02em;
      }

      /* Mode Toggle */
      .mode-toggle-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .mode-toggle {
        display: inline-flex;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 6px;
        gap: 6px;
        backdrop-filter: blur(20px);
      }

      .controls-group {
        display: flex;
        align-items: center;
        gap: 12px;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 8px 16px;
        backdrop-filter: blur(20px);
      }

      .dataset-select {
        padding: 8px 16px;
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text-primary);
        font-family: "Inter", sans-serif;
        font-size: 0.85rem;
        cursor: pointer;
        transition: border-color 0.3s;
        outline: none;
      }

      .dataset-select:hover {
        border-color: rgba(100, 120, 180, 0.35);
      }

      .btn {
        padding: 8px 20px;
        border: none;
        border-radius: 8px;
        font-family: "Inter", sans-serif;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        background: var(--accent-blue);
        color: white;
      }

      .btn:hover {
        background: #2563eb;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-secondary {
        background: rgba(100, 120, 180, 0.2);
        color: var(--text-primary);
      }

      .btn-secondary:hover {
        background: rgba(100, 120, 180, 0.3);
      }

      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 26px;
      }

      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(100, 120, 180, 0.2);
        transition: 0.4s;
        border-radius: 26px;
      }

      .toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }

      input:checked + .toggle-slider {
        background-color: var(--accent-blue);
      }

      input:checked + .toggle-slider:before {
        transform: translateX(24px);
      }

      .toggle-label {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-right: 8px;
      }

      .mode-btn {
        padding: 12px 32px;
        border: none;
        border-radius: 8px;
        font-family: "Inter", sans-serif;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        background: transparent;
        color: var(--text-muted);
      }

      .mode-btn.active {
        background: var(--accent-blue);
        color: white;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      }

      .mode-btn:hover:not(.active) {
        color: var(--text-primary);
        background: rgba(100, 120, 180, 0.1);
      }

      /* Main Layout */
      .main-layout {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 20px;
      }

      /* Left Section */
      .left-section {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      /* Top Info Row */
      .info-row {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
      }

      .info-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 24px;
        backdrop-filter: blur(20px);
        transition: all 0.3s;
      }

      .info-card:hover {
        border-color: rgba(100, 120, 180, 0.3);
        transform: translateY(-2px);
      }

      .info-card h3 {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-bottom: 12px;
      }

      .info-card .value {
        font-size: 2.5rem;
        font-weight: 900;
        line-height: 1;
        margin-bottom: 8px;
      }

      .info-card .value.bullish { color: var(--accent-bullish); }
      .info-card .value.bearish { color: var(--accent-bearish); }
      .info-card .value.neutral { color: var(--accent-neutral); }

      .info-card .label {
        font-size: 0.85rem;
        color: var(--text-secondary);
      }

      .badge {
        display: inline-block;
        padding: 6px 16px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .badge.bullish {
        background: linear-gradient(135deg, #22c55e, #10b981);
        color: white;
      }
      .badge.bearish {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
      }
      .badge.neutral {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
      }

      .details-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .detail-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid var(--border);
      }

      .detail-item:last-child {
        border-bottom: none;
      }

      .detail-label {
        font-size: 0.85rem;
        color: var(--text-secondary);
      }

      .detail-value {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-primary);
      }

      /* Chart Card */
      .chart-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 24px;
        backdrop-filter: blur(20px);
        min-height: 400px;
      }

      .chart-card h3 {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-bottom: 20px;
      }

      .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .chart-selector {
        display: flex;
        gap: 8px;
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 4px;
      }

      .chart-btn {
        padding: 6px 16px;
        border: none;
        border-radius: 6px;
        font-family: "Inter", sans-serif;
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        background: transparent;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .chart-btn:hover {
        color: var(--text-primary);
      }

      .chart-btn.active {
        background: var(--accent-blue);
        color: white;
      }

      .chart-container {
        position: relative;
        height: 350px;
      }

      .chart-wrapper {
        display: none;
        height: 100%;
      }

      .chart-wrapper.active {
        display: block;
      }

      /* Right Section - News */
      .right-section {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .news-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
        backdrop-filter: blur(20px);
      }

      .news-card h3 {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border);
      }

      .news-item {
        padding: 16px;
        background: rgba(100, 120, 180, 0.05);
        border-radius: 8px;
        margin-bottom: 12px;
        border-left: 3px solid transparent;
        transition: all 0.3s;
      }

      .news-item:hover {
        background: rgba(100, 120, 180, 0.1);
        transform: translateX(4px);
      }

      .news-item.bullish {
        border-left-color: var(--accent-bullish);
      }

      .news-item.bearish {
        border-left-color: var(--accent-bearish);
      }

      .news-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
        line-height: 1.4;
      }

      .news-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.75rem;
        color: var(--text-secondary);
      }

      .news-score {
        font-weight: 700;
        padding: 2px 8px;
        border-radius: 4px;
        background: rgba(59, 130, 246, 0.1);
      }

      .news-score.bullish { 
        color: var(--accent-bullish);
        background: rgba(34, 197, 94, 0.1);
      }
      .news-score.bearish { 
        color: var(--accent-bearish);
        background: rgba(239, 68, 68, 0.1);
      }

      .latest-news-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
        backdrop-filter: blur(20px);
        max-height: 400px;
        overflow-y: auto;
      }

      .latest-news-card h3 {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border);
        position: sticky;
        top: 0;
        background: var(--bg-card);
        backdrop-filter: blur(20px);
        z-index: 1;
      }

      .news-article {
        padding: 12px;
        border-bottom: 1px solid var(--border);
        transition: background 0.3s;
      }

      .news-article:hover {
        background: rgba(100, 120, 180, 0.05);
      }

      .news-article:last-child {
        border-bottom: none;
      }

      .article-title {
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--text-primary);
        line-height: 1.4;
        margin-bottom: 6px;
      }

      .article-time {
        font-size: 0.7rem;
        color: var(--text-secondary);
      }

      /* Loading spinner */
      .spinner {
        border: 3px solid var(--border);
        border-top: 3px solid var(--accent-blue);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* Scrollbar styling */
      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: rgba(100, 120, 180, 0.05);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb {
        background: rgba(100, 120, 180, 0.2);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: rgba(100, 120, 180, 0.3);
      }

      /* Responsive */
      @media (max-width: 1200px) {
        .main-layout {
          grid-template-columns: 1fr;
        }
        
        .info-row {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 768px) {
        .header h1 {
          font-size: 1.8rem;
        }
        
        .mode-btn {
          padding: 10px 20px;
          font-size: 0.85rem;
        }
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <div class="header">
        <h1>SenTrack</h1>
      </div>

      <!-- Mode Toggle -->
      <div class="mode-toggle-container">
        <div class="mode-toggle">
          <button class="mode-btn active" id="testModeBtn">Test / Demo</button>
          <button class="mode-btn" id="liveModeBtn">Live</button>
        </div>

        <!-- Controls Group -->
        <div class="controls-group" id="controlsGroup">
          <!-- Dataset Selector (Test Mode Only) -->
          <select class="dataset-select" id="datasetSelect" style="display: none;">
            <option value="sample">Sample Tweets</option>
            <option value="kaggle_sentiment140">Sentiment140 (Kaggle)</option>
            <option value="kaggle_bitcoin">Bitcoin Sentiment (Kaggle)</option>
          </select>

          <!-- Auto Analysis Toggle -->
          <span class="toggle-label">Auto</span>
          <label class="toggle-switch">
            <input type="checkbox" id="autoToggle">
            <span class="toggle-slider"></span>
          </label>
          
          <!-- Interval Selector (shown when auto is enabled) -->
          <select class="dataset-select" id="intervalSelect" style="display: none;">
            <option value="30s">30 sec</option>
            <option value="1min" selected>1 min</option>
            <option value="2min">2 min</option>
            <option value="5min">5 min</option>
            <option value="10min">10 min</option>
            <option value="30min">30 min</option>
            <option value="1hr">1 hour</option>
          </select>
          
          <!-- Status Indicator -->
          <div id="statusIndicator" style="display: none; padding: 8px 16px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; font-size: 0.85rem; color: var(--accent-blue);">
            <span id="statusText">● Collecting...</span>
          </div>
          
          <!-- Article Counter -->
          <div id="articleCounter" style="display: none; padding: 8px 16px; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px; font-size: 0.85rem; color: var(--accent-bullish); font-weight: 600;">
            <span id="counterText">0 articles</span>
          </div>

          <!-- Analyze Button -->
          <button class="btn" id="analyzeBtn">Analyze Now</button>
        </div>
      </div>

      <!-- Main Layout -->
      <div class="main-layout">
        <!-- Left Section -->
        <div class="left-section">
          <!-- Info Row -->
          <div class="info-row">
            <!-- Score Card -->
            <div class="info-card">
              <h3>Score</h3>
              <div class="value neutral" id="scoreValue">--</div>
              <div class="label">Community Vibe</div>
            </div>

            <!-- Market Sentiment Card -->
            <div class="info-card">
              <h3>Market Sentiment</h3>
              <span class="badge neutral" id="sentimentBadge">Neutral</span>
            </div>

            <!-- Analysis Details Card -->
            <div class="info-card">
              <h3>Analysis Details</h3>
              <div class="details-list">
                <div class="detail-item">
                  <span class="detail-label">Sample Size</span>
                  <span class="detail-value" id="sampleSize">--</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Raw Score</span>
                  <span class="detail-value" id="rawScore">--</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Engine</span>
                  <span class="detail-value" id="engine">--</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Chart Card -->
          <div class="chart-card">
            <div class="chart-header">
              <h3>Sentiment Analysis</h3>
              <div class="chart-selector">
                <button class="chart-btn active" data-chart="line">Line</button>
                <button class="chart-btn" data-chart="bar">Bar</button>
                <button class="chart-btn" data-chart="candlestick">Candlestick</button>
              </div>
            </div>
            <div class="chart-container">
              <div class="chart-wrapper active" id="lineChartWrapper">
                <canvas id="trendChart"></canvas>
              </div>
              <div class="chart-wrapper" id="barChartWrapper">
                <canvas id="barChart"></canvas>
              </div>
              <div class="chart-wrapper" id="candlestickChartWrapper">
                <canvas id="candlestickChart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Section - News -->
        <div class="right-section">
          <!-- Most Bullish News -->
          <div class="news-card">
            <h3>Most Bullish</h3>
            <div class="news-item bullish" id="mostBullish">
              <div class="news-title">Loading...</div>
              <div class="news-meta">
                <span>--</span>
                <span class="news-score bullish">--</span>
              </div>
            </div>
          </div>

          <!-- Most Bearish News -->
          <div class="news-card">
            <h3>Most Bearish</h3>
            <div class="news-item bearish" id="mostBearish">
              <div class="news-title">Loading...</div>
              <div class="news-meta">
                <span>--</span>
                <span class="news-score bearish">--</span>
              </div>
            </div>
          </div>

          <!-- Latest News -->
          <div class="latest-news-card">
            <h3>Latest News</h3>
            <div id="latestNews">
              <div class="spinner"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentMode = 'test';
      let currentDataset = 'sample';
      let currentChartType = 'line';
      let chart = null;
      let barChart = null;
      let candlestickChart = null;
      let autoRefreshInterval = null;

      // Initialize
      async function init() {
        await fetchScore();
        await fetchHistory();
        setupEventListeners();
        await syncAutomationState();
      }

      async function syncAutomationState() {
        // On page load, check if backend has a running automation and stop it
        // The toggle starts unchecked, so backend should not be running
        try {
          const resp = await fetch('/api/live/status');
          const status = await resp.json();
          if (status.active) {
            console.log('Backend automation was running on page load — stopping it');
            await fetch('/api/live/automation', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ action: 'stop' })
            });
          }
        } catch (e) {
          console.warn('Could not sync automation state:', e);
        }
      }

      function setupEventListeners() {
        // Mode buttons
        document.getElementById('testModeBtn').addEventListener('click', () => switchMode('test'));
        document.getElementById('liveModeBtn').addEventListener('click', () => switchMode('live'));
        
        // Dataset selector
        document.getElementById('datasetSelect').addEventListener('change', (e) => {
          currentDataset = e.target.value;
        });
        
        // Auto toggle
        document.getElementById('autoToggle').addEventListener('change', (e) => {
          const intervalSelect = document.getElementById('intervalSelect');
          const statusIndicator = document.getElementById('statusIndicator');
          const articleCounter = document.getElementById('articleCounter');
          
          if (e.target.checked) {
            intervalSelect.style.display = 'block';
            statusIndicator.style.display = 'block';
            
            if (currentMode === 'live') {
              articleCounter.style.display = 'block';
              document.getElementById('statusText').textContent = '● Live: Collecting news...';
              document.getElementById('counterText').textContent = '0 articles';
              startLiveAutomation();
            } else {
              articleCounter.style.display = 'none';
              document.getElementById('statusText').textContent = '● Auto: Analyzing...';
              startAutoRefresh();
            }
          } else {
            intervalSelect.style.display = 'none';
            statusIndicator.style.display = 'none';
            articleCounter.style.display = 'none';
            
            if (currentMode === 'live') {
              stopLiveAutomation();
            } else {
              stopAutoRefresh();
            }
          }
        });
        
        // Interval selector change
        document.getElementById('intervalSelect').addEventListener('change', () => {
          if (document.getElementById('autoToggle').checked) {
            if (currentMode === 'live') {
              stopLiveAutomation();
              startLiveAutomation();
            } else {
              stopAutoRefresh();
              startAutoRefresh();
            }
          }
        });
        
        // Analyze button
        document.getElementById('analyzeBtn').addEventListener('click', triggerAnalysis);
        
        // Chart type buttons
        document.querySelectorAll('.chart-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const chartType = e.target.dataset.chart;
            switchChartType(chartType);
          });
        });
      }

      async function switchMode(mode) {
        // Stop any active automation first
        const autoToggle = document.getElementById('autoToggle');
        if (autoToggle.checked) {
          if (currentMode === 'live') {
            await stopLiveAutomation();
          } else {
            stopAutoRefresh();
          }
          autoToggle.checked = false;
          document.getElementById('intervalSelect').style.display = 'none';
          document.getElementById('statusIndicator').style.display = 'none';
          document.getElementById('articleCounter').style.display = 'none';
        }
        
        currentMode = mode;
        
        // Update UI
        document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`${mode}ModeBtn`).classList.add('active');
        
        // Show/hide dataset selector based on mode
        const datasetSelect = document.getElementById('datasetSelect');
        if (mode === 'test') {
          datasetSelect.style.display = 'block';
        } else {
          datasetSelect.style.display = 'none';
        }
        
        // Clear existing charts
        if (chart) {
          chart.destroy();
          chart = null;
        }
        if (barChart) {
          barChart.destroy();
          barChart = null;
        }
        if (candlestickChart) {
          candlestickChart.destroy();
          candlestickChart = null;
        }
        
        // Fetch new data for this mode
        await fetchScore();
        await fetchHistory();
      }

      function switchChartType(type) {
        currentChartType = type;
        
        // Update buttons
        document.querySelectorAll('.chart-btn').forEach(btn => {
          btn.classList.remove('active');
          if (btn.dataset.chart === type) {
            btn.classList.add('active');
          }
        });
        
        // Show/hide chart wrappers
        document.querySelectorAll('.chart-wrapper').forEach(wrapper => {
          wrapper.classList.remove('active');
        });
        document.getElementById(`${type}ChartWrapper`).classList.add('active');
      }

      async function triggerAnalysis() {
        const btn = document.getElementById('analyzeBtn');
        btn.disabled = true;
        btn.textContent = 'Analyzing...';
        
        try {
          const intervalValue = document.getElementById('intervalSelect').value;
          
          const payload = {
            mode: currentMode,
            dataset: currentDataset,
            interval: intervalValue
          };
          
          const response = await fetch('/api/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          
          const data = await response.json();
          
          if (data.error) {
            alert('Error: ' + data.error);
          } else {
            await fetchScore();
            await fetchHistory();
          }
        } catch (error) {
          console.error('Error triggering analysis:', error);
          alert('Failed to trigger analysis');
        } finally {
          btn.disabled = false;
          btn.textContent = 'Analyze Now';
        }
      }

      function startAutoRefresh() {
        if (autoRefreshInterval) return;
        
        // Get selected interval
        const intervalValue = document.getElementById('intervalSelect').value;
        const intervalMap = {
          '30s': 30000,
          '1min': 60000,
          '2min': 120000,
          '5min': 300000,
          '10min': 600000,
          '30min': 1800000,
          '1hr': 3600000
        };
        
        const intervalMs = intervalMap[intervalValue] || 60000;
        
        // Run analysis at selected interval
        autoRefreshInterval = setInterval(async () => {
          await triggerAnalysis();
        }, intervalMs);
        
        // Run immediately
        triggerAnalysis();
      }

      function stopAutoRefresh() {
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
        }
      }

      // Live mode automation functions
      let realtimeNewsInterval = null;
      let lastLiveHistoryLen = 0;

      async function startLiveAutomation() {
        const intervalValue = document.getElementById('intervalSelect').value;
        lastLiveHistoryLen = 0; // reset tracker
        
        try {
          const response = await fetch('/api/live/automation', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'start',
              interval: intervalValue,
              query: 'crypto OR bitcoin OR ethereum'
            })
          });
          
          const data = await response.json();
          
          if (data.error) {
            alert('Error: ' + data.error);
            document.getElementById('autoToggle').checked = false;
            return;
          }
          
          console.log('Live automation started:', data);
          startRealtimeNewsPolling();
          
        } catch (error) {
          console.error('Error starting live automation:', error);
          alert('Failed to start live automation');
          document.getElementById('autoToggle').checked = false;
        }
      }

      async function stopLiveAutomation() {
        try {
          const response = await fetch('/api/live/automation', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'stop' })
          });
          
          const data = await response.json();
          console.log('Live automation stopped:', data);
          
          // Stop polling
          stopRealtimeNewsPolling();
          
        } catch (error) {
          console.error('Error stopping live automation:', error);
        }
      }

      function startRealtimeNewsPolling() {
        if (realtimeNewsInterval) return;
        
        realtimeNewsInterval = setInterval(async () => {
          try {
            // 1. Fetch live status (progress, countdown, buffer count)
            const statusResp = await fetch('/api/live/status');
            const status = await statusResp.json();

            if (status.active) {
              const statusText = document.getElementById('statusText');
              const counterText = document.getElementById('counterText');
              const remaining = Math.round(status.remaining_seconds);
              const total = status.interval_seconds || 1;
              const elapsed = Math.round(status.elapsed_seconds);
              const pct = Math.min(100, Math.round((elapsed / total) * 100));
              const buf = status.articles_in_buffer;

              if (remaining > 0 && buf < 15) {
                statusText.textContent = `● Collecting... ${remaining}s left (need ${15 - buf} more)`;
              } else if (remaining > 0) {
                statusText.textContent = `● Collecting... ${remaining}s left`;
              } else if (buf < 15) {
                statusText.textContent = `● Waiting for min 15 articles (${buf} so far)...`;
              } else {
                statusText.textContent = `● Sampling & analyzing...`;
              }
              counterText.textContent = `${buf}/120 collected | sampling 9 at end | ${pct}%`;

              // 2. Detect new interval score → refresh charts & score
              if (status.total_scores > lastLiveHistoryLen) {
                lastLiveHistoryLen = status.total_scores;
                await fetchScore();
                await fetchHistory();
              }
            }

            // 3. Fetch real-time news feed
            await fetchRealtimeNews();

          } catch (error) {
            console.error('Polling error:', error);
          }
        }, 3000);
        
        // Run once immediately
        fetchRealtimeNews();
      }

      function stopRealtimeNewsPolling() {
        if (realtimeNewsInterval) {
          clearInterval(realtimeNewsInterval);
          realtimeNewsInterval = null;
        }
      }

      async function fetchRealtimeNews() {
        try {
          const response = await fetch('/api/live/realtime-news');
          const data = await response.json();
          
          if (data.news && data.news.length > 0) {
            updateLatestNewsRealtime(data.news);
          }
        } catch (error) {
          console.error('Error fetching real-time news:', error);
        }
      }

      async function fetchScore() {
        try {
          // Add timestamp to prevent caching
          const response = await fetch(`/api/score?mode=${currentMode}&_t=${Date.now()}`);
          const data = await response.json();
          
          console.log(`Fetched score for ${currentMode} mode:`, data.score, data.classification);
          
          if (data.error) {
            console.error(data.error);
            return;
          }

          // Update score
          const scoreEl = document.getElementById('scoreValue');
          scoreEl.textContent = data.score.toFixed(1);
          
          // Update sentiment class
          const sentiment = data.classification.toLowerCase();
          scoreEl.className = `value ${sentiment}`;
          
          // Update badge
          const badge = document.getElementById('sentimentBadge');
          badge.textContent = data.classification;
          badge.className = `badge ${sentiment}`;
          
          // Update details
          document.getElementById('sampleSize').textContent = data.sample_size || '--';
          document.getElementById('rawScore').textContent = data.raw_score ? data.raw_score.toFixed(2) : '--';
          document.getElementById('engine').textContent = data.nlp_engine || '--';
          
          // Update news items
          updateNewsItems(data);
          
        } catch (error) {
          console.error('Error fetching score:', error);
        }
      }

      function updateNewsItems(data) {
        // Most Bullish
        if (data.highest_tweet) {
          const bullishEl = document.getElementById('mostBullish');
          bullishEl.innerHTML = `
            <div class="news-title">${truncateText(data.highest_tweet.text, 80)}</div>
            <div class="news-meta">
              <span>${data.highest_tweet.label}</span>
              <span class="news-score bullish">${data.highest_tweet.score.toFixed(1)}</span>
            </div>
          `;
        }
        
        // Most Bearish
        if (data.lowest_tweet) {
          const bearishEl = document.getElementById('mostBearish');
          bearishEl.innerHTML = `
            <div class="news-title">${truncateText(data.lowest_tweet.text, 80)}</div>
            <div class="news-meta">
              <span>${data.lowest_tweet.label}</span>
              <span class="news-score bearish">${data.lowest_tweet.score.toFixed(1)}</span>
            </div>
          `;
        }
      }

      async function fetchHistory() {
        try {
          // Add timestamp to prevent caching
          const response = await fetch(`/api/history?mode=${currentMode}&_t=${Date.now()}`);
          const data = await response.json();
          
          console.log(`Fetched history for ${currentMode} mode:`, data.history?.length || 0, 'items');
          
          if (data.history && data.history.length > 0) {
            updateCharts(data.history);
            updateLatestNews(data.history);
          } else {
            // Clear charts if no data
            console.log(`No history data for ${currentMode} mode - clearing charts`);
            if (chart) chart.destroy();
            if (barChart) barChart.destroy();
            if (candlestickChart) candlestickChart.destroy();
            chart = barChart = candlestickChart = null;
          }
        } catch (error) {
          console.error('Error fetching history:', error);
        }
      }

      function updateCharts(history) {
        console.log(`[${currentMode.toUpperCase()}] Updating charts with ${history.length} data points`);
        updateLineChart(history);
        updateBarChart(history);
        updateCandlestickChart(history);
      }

      function updateLineChart(history) {
        const ctx = document.getElementById('trendChart').getContext('2d');
        
        const labels = history.map(h => new Date(h.timestamp).toLocaleTimeString());
        const scores = history.map(h => h.score);
        
        if (chart) {
          chart.destroy();
        }
        
        chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Sentiment Score',
              data: scores,
              borderColor: 'rgb(59, 130, 246)',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              tension: 0.4,
              fill: true,
              pointRadius: 4,
              pointHoverRadius: 6,
              pointBackgroundColor: 'rgb(59, 130, 246)',
              pointBorderColor: '#fff',
              pointBorderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                grid: {
                  color: 'rgba(100, 120, 180, 0.1)'
                },
                ticks: {
                  color: '#94a3b8'
                }
              },
              x: {
                grid: {
                  color: 'rgba(100, 120, 180, 0.1)'
                },
                ticks: {
                  color: '#94a3b8',
                  maxRotation: 45,
                  minRotation: 45
                }
              }
            }
          }
        });
      }

      function updateBarChart(history) {
        const ctx = document.getElementById('barChart').getContext('2d');
        
        if (history.length === 0) {
          return;
        }
        
        // Count sentiment classifications
        const counts = { Bullish: 0, Neutral: 0, Bearish: 0 };
        history.forEach(h => {
          if (h.classification in counts) {
            counts[h.classification]++;
          }
        });
        
        if (barChart) {
          barChart.destroy();
        }
        
        barChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['Bullish', 'Neutral', 'Bearish'],
            datasets: [{
              label: 'Sentiment Count',
              data: [counts.Bullish, counts.Neutral, counts.Bearish],
              backgroundColor: [
                'rgba(34, 197, 94, 0.7)',
                'rgba(245, 158, 11, 0.7)',
                'rgba(239, 68, 68, 0.7)'
              ],
              borderColor: [
                'rgb(34, 197, 94)',
                'rgb(245, 158, 11)',
                'rgb(239, 68, 68)'
              ],
              borderWidth: 2,
              borderRadius: 8
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                labels: {
                  color: '#94a3b8',
                  font: {
                    size: 12
                  }
                }
              },
              tooltip: {
                backgroundColor: 'rgba(15, 23, 42, 0.9)',
                titleColor: '#e2e8f0',
                bodyColor: '#94a3b8',
                borderColor: 'rgba(100, 120, 180, 0.3)',
                borderWidth: 1,
                padding: 12,
                displayColors: true
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  color: 'rgba(100, 120, 180, 0.1)'
                },
                ticks: {
                  color: '#94a3b8',
                  stepSize: 1,
                  font: {
                    size: 11
                  }
                }
              },
              x: {
                grid: {
                  display: false
                },
                ticks: {
                  color: '#94a3b8',
                  font: {
                    size: 12,
                    weight: 600
                  }
                }
              }
            }
          }
        });
      }

      function updateCandlestickChart(history) {
        const ctx = document.getElementById('candlestickChart').getContext('2d');
        
        if (history.length === 0) {
          return;
        }
        
        // Build OHLC data from sentiment history
        // open = previous close (or same as close for first), close = current score
        // high/low add slight variance from raw_score to simulate real candle wicks
        const ohlcData = [];
        
        for (let i = 0; i < history.length; i++) {
          const current = history[i];
          const prev = i > 0 ? history[i - 1] : current;
          
          const open = prev.score;
          const close = current.score;
          const raw = current.raw_score != null ? current.raw_score : close;
          
          // Wicks extend to the extremes of open, close, raw_score + small random jitter
          const jitter = (Math.abs(close - open) * 0.15) + 1.5;
          const high = Math.min(100, Math.max(open, close, raw) + jitter);
          const low  = Math.max(0,   Math.min(open, close, raw) - jitter);
          
          const ts = luxon.DateTime.fromISO(current.timestamp).isValid
            ? luxon.DateTime.fromISO(current.timestamp)
            : luxon.DateTime.fromJSDate(new Date(current.timestamp));
          
          ohlcData.push({
            x: ts.toMillis(),
            o: open,
            h: high,
            l: low,
            c: close
          });
        }
        
        if (candlestickChart) {
          candlestickChart.destroy();
        }
        
        candlestickChart = new Chart(ctx, {
          type: 'candlestick',
          data: {
            datasets: [{
              label: 'Sentiment OHLC',
              data: ohlcData,
              color: {
                up: 'rgba(34, 197, 94, 1)',      // bullish body border
                down: 'rgba(239, 68, 68, 1)',     // bearish body border
                unchanged: 'rgba(148, 163, 184, 1)'
              },
              backgroundColors: {
                up: 'rgba(34, 197, 94, 0.85)',    // bullish fill
                down: 'rgba(239, 68, 68, 0.85)',  // bearish fill
                unchanged: 'rgba(148, 163, 184, 0.5)'
              },
              borderColor: {
                up: 'rgb(34, 197, 94)',
                down: 'rgb(239, 68, 68)',
                unchanged: 'rgb(148, 163, 184)'
              }
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                backgroundColor: 'rgba(15, 23, 42, 0.95)',
                titleColor: '#e2e8f0',
                bodyColor: '#94a3b8',
                borderColor: 'rgba(100, 120, 180, 0.3)',
                borderWidth: 1,
                padding: 12,
                displayColors: false,
                callbacks: {
                  title: function(tooltipItems) {
                    const d = luxon.DateTime.fromMillis(tooltipItems[0].parsed.x);
                    return d.toFormat('HH:mm:ss');
                  },
                  label: function(context) {
                    const o = context.parsed.o;
                    const h = context.parsed.h;
                    const l = context.parsed.l;
                    const c = context.parsed.c;
                    const dir = c >= o ? '▲ Bullish' : '▼ Bearish';
                    return [
                      `Open:  ${o.toFixed(1)}`,
                      `High:  ${h.toFixed(1)}`,
                      `Low:   ${l.toFixed(1)}`,
                      `Close: ${c.toFixed(1)}`,
                      ``,
                      dir
                    ];
                  }
                }
              }
            },
            scales: {
              x: {
                type: 'timeseries',
                time: {
                  unit: 'minute',
                  displayFormats: {
                    minute: 'HH:mm',
                    hour: 'HH:mm'
                  },
                  tooltipFormat: 'HH:mm:ss'
                },
                ticks: {
                  color: '#94a3b8',
                  maxRotation: 45,
                  minRotation: 0,
                  font: { size: 10 },
                  source: 'data',
                  autoSkip: true,
                  maxTicksLimit: 12
                },
                grid: {
                  color: 'rgba(100, 120, 180, 0.08)'
                }
              },
              y: {
                min: 0,
                max: 100,
                grid: {
                  color: 'rgba(100, 120, 180, 0.1)'
                },
                ticks: {
                  color: '#94a3b8',
                  font: { size: 11 },
                  stepSize: 10,
                  callback: function(value) {
                    if (value === 50) return '50 — Neutral';
                    return value;
                  }
                }
              }
            }
          }
        });
      }

      function updateLatestNews(history) {
        const newsContainer = document.getElementById('latestNews');
        
        if (history.length === 0) {
          newsContainer.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">No data available</div>';
          return;
        }
        
        const recentItems = history.slice(-10).reverse();
        
        newsContainer.innerHTML = recentItems.map(item => `
          <div class="news-article">
            <div class="article-title">
              Score: ${item.score.toFixed(1)} - ${item.classification} (${item.sample_size} samples)
            </div>
            <div class="article-time">${new Date(item.timestamp).toLocaleString()}</div>
          </div>
        `).join('');
      }

      function updateLatestNewsRealtime(newsArticles) {
        const newsContainer = document.getElementById('latestNews');
        
        if (!newsArticles || newsArticles.length === 0) {
          newsContainer.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">Waiting for news...</div>';
          return;
        }
        
        const recentNews = newsArticles.slice(0, 25);
        
        newsContainer.innerHTML = recentNews.map((article, index) => {
          const isAnalyzed = article.analyzed === true && article.sentiment;
          const isSampled  = article.sampled === true;

          // Colours based on analysis state
          let borderColor = 'var(--border)';          // default: grey
          let sentimentHTML = '<span style="color: var(--text-muted); font-size: 0.8rem; font-style: italic;">Pending…</span>';

          if (isAnalyzed) {
            const label = article.sentiment.label;
            borderColor = label === 'positive' ? 'var(--accent-bullish)' :
                          label === 'negative' ? 'var(--accent-bearish)' :
                          'var(--accent-neutral)';
            sentimentHTML = `<span style="color: ${borderColor}; font-weight: 600; font-size: 0.85rem;">${article.score.toFixed(1)} – ${label.toUpperCase()}</span>`;
          }

          const sampledBadge = isSampled
            ? '<span style="background: rgba(59,130,246,0.2); color: var(--accent-blue); padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-left: 6px;">SAMPLED</span>'
            : '';

          const timeAgo = getTimeAgo(new Date(article.timestamp));
          const isNew = (new Date() - new Date(article.timestamp)) < 5000;
          const pulseStyle = isNew ? 'animation: pulse 0.5s ease-in-out;' : '';

          return `
            <div class="news-article" style="${pulseStyle} border-left: 3px solid ${borderColor}; padding: 8px 12px; margin-bottom: 6px;">
              <div class="article-title" style="display: flex; align-items: flex-start;">
                <span style="color: var(--text-muted); font-size: 0.75rem; margin-right: 8px; flex-shrink: 0;">#${index + 1}</span>
                <span>${truncateText(article.text, 120)}</span>
                ${sampledBadge}
              </div>
              <div class="article-time" style="display: flex; justify-content: space-between; align-items: center; margin-top: 4px;">
                <span style="font-size: 0.75rem;">${timeAgo}</span>
                ${sentimentHTML}
              </div>
            </div>
          `;
        }).join('');
      }

      function getTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        
        if (seconds < 60) return `${seconds}s ago`;
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `${minutes}m ago`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours}h ago`;
        return date.toLocaleDateString();
      }

      function truncateText(text, maxLength) {
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
      }

      // Initialize on load
      init();
    </script>
  </body>
</html>
